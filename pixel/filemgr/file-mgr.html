<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>七牛云文件管理</title>
		<!-- Bootstrap -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
		<!-- HTML5 shim 和 Respond.js 是为了让 IE8 支持 HTML5 元素和媒体查询（media queries）功能 -->
		<!-- 警告：通过 file:// 协议（就是直接将 html 页面拖拽到浏览器中）访问页面时 Respond.js 不起作用 -->
		<!--[if lt IE 9]>
		  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
		  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
		<![endif]-->
		<link href="css/file-mgr.css" type="text/css" rel="stylesheet" />
	</head>
	<body>
		<div class="container">
			<h3>上传图片</h3>	
			<div class="row">
				<div class="form-inline col-xs-3 col-sm-3 col-lg-3">
					<label>空间：</label>
					<select class="bucket" id="selectBucket">
						<option>ss-wallpapers</option>
					</select>
				</div>
				<div class="input-group col-xs-9 col-sm-9 col-lg-9">
					<input type="file" id="file" accept="image/*" class="form-control select-file" placeholder="选择图片" onchange="onFileChange()">
					<span class="input-group-btn">
						<button class="btn btn-default" id="acitonUpload" type="button">上传</button>
					</span>
				</div>
			</div>		
			<div class="row params">
				<div class="col-xs-2 col-sm-2 col-lg-2">
					<label for="inputCategory" class="sr-only">类别</label>
					<input type="text" id="inputCategory" class="form-control" placeholder="类别" required>
				</div>
				<div class="col-xs-6 col-sm-6 col-lg-6">
					<label for="inputDesc" class="sr-only">描述</label>
					<input type="text" id="inputDesc" class="form-control" placeholder="描述" required>
				</div>
				<span id="imgSize" class="info"></span>
				<span id="md5" class="info md5"></span>
			</div>	
			
			<div class="progress">
				<div class="progress-bar" id="progress" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"
				 style="min-width: 2em; width: 0%;">
					0%
				</div>
			</div>
		</div>
		<!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
		<script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
		<!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
		<script src="js/spark-md5.min.js"></script>
		<script src="js/config.js"></script>
		<script src="https://unpkg.com/qiniu-js@2.5.5/dist/qiniu.min.js"></script>
		<script>
			var uploadToken, imgWidth, imgHeight, md5, uploading, existMd5, filename, fileKey;
			globalToken = window.location.href.split("#")[1];
			$(function() {
				$('#acitonUpload').click(function() {
					if (uploading) {
						alert("正在上传，请稍后再试！");
						return;
					}
					if (!$('#file').val()) {
						alert("请选择图片");
						return;
					}
					var category = $('#inputCategory').val();
					var description = $('#inputDesc').val();
					if (category == "") {
						alert("请填写类别");
						return;
					}
					if (description == "") {
						alert("请填写描述");
						return;
					}
					if (uploadToken == null) {
						//获取上传凭证
						getUploadToken(upload);
					} else {
						upload();
					}
				});
			});

			function getUploadToken(callback) {
				$.ajax({
					url: getDomain() + '/qiniu/upload/token',
					beforeSend: function(request) {
						request.setRequestHeader("Access-Token", globalToken);
					},
					data: "bucket=" + $("#selectBucket").val(),
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
						if (data.code == 200) {
							uploadToken = data.msg;
							callback();
						} else {
							alert("请重新登录！code = " + data.code);
						}
					},
					error: function(xhr, type, errorThrown) {
						alert("请求失败: " + xhr.textStatus);
					}
				});
			}
			
			function checkExists(hash) {
				var file = $('#file')[0].files[0];
				var filePath = $("#file").val();
				var filenameIndex = filePath.lastIndexOf('/');
				if (filenameIndex == -1) {
					filenameIndex = filePath.lastIndexOf('\\');
				}
				filename = filePath.substr(filenameIndex + 1);
				var suffixIndex = filePath.lastIndexOf(".");
				var suffix = filePath.substr(suffixIndex);
				fileKey = hash + suffix;
				$.ajax({
					url: getDomain() + '/qiniu/exists',
					beforeSend: function(request) {
						request.setRequestHeader("Access-Token", globalToken);
					},
					data: "fileKey=" + fileKey,
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
						if (data.code == 200) {
							if (data.data == true) {
								existMd5 = hash;
								alert("文件已存在，请重新选择！");
							}
						} else {
							alert("请重新登录！");
						}
					},
					error: function(xhr, type, errorThrown) {
						alert("请求失败: " + xhr.textStatus);
					}
				});
			}

			function onFileChange() {				
				calcMD5();
				getImageSize();
			}

			function getImageSize() {
				var file = $('#file')[0].files[0];
				//读取图片数据
				var reader = new FileReader();
				reader.onload = function(e) {
					//加载图片获取图片真实宽度和高度
					var image = new Image();
					image.onload = function() {
						imgWidth = image.width;
						imgHeight = image.height;
						$('#imgSize').text("尺寸: " + imgWidth + "x" + imgHeight);
					};
					image.src = this.result;
				};
				reader.readAsDataURL(file);
			}

			function calcMD5() {
				var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice,
					file = $('#file')[0].files[0],
					chunkSize = 2097152,                             // Read in chunks of 2MB
					chunks = Math.ceil(file.size / chunkSize),
					currentChunk = 0,
					spark = new SparkMD5.ArrayBuffer(),
					fileReader = new FileReader();

				fileReader.onload = function (e) {
					spark.append(e.target.result);                   // Append array buffer
					currentChunk++;

					if (currentChunk < chunks) {
						loadNext();
					} else {
						md5 = spark.end();
						$('#md5').text("MD5: " + md5);
						//查询文件在服务器是否已存在
						checkExists(md5);
					}
				};

				fileReader.onerror = function () {
					$('#md5').text("MD5获取失败");
				};

				function loadNext() {
					var start = currentChunk * chunkSize,
						end = ((start + chunkSize) >= file.size) ? file.size : start + chunkSize;
					fileReader.readAsArrayBuffer(blobSlice.call(file, start, end));
				}

				loadNext();
			}
			
			function upload() {		
				if (existMd5 == md5) {
					alert("文件已存在，请重新选择！");
					return;
				}
				var progressBar = $('#progress');
				var observer = {
					next(res) {
						var percent = res.total.percent.toFixed(2);
						progressBar.attr('style', "min-width: 2em; width: " + percent + "%;");
						progressBar.text(percent + '%');
					},
					error(err) {
						uploading = false;
						alert("上传失败！" + err.message);
					},
					complete(res) {
						uploading = false;
						alert("上传成功！")
					}
				};
				var file = $('#file')[0].files[0];
				var category = $('#inputCategory').val();
				var description = $('#inputDesc').val();
				var config = {
					useCdnDomain: true, //使用cdn加速
				};
				var putExtra = {
				  fname: filename,
				  params: {
					  "x:description": description,
					  "x:category": category,
					  "x:width": imgWidth,
					  "x:height": imgHeight
				  },
				  mimeType: ["image/png", "image/jpeg", "image/gif"]
				};
				var observable = qiniu.upload(file, fileKey, uploadToken, putExtra, config)
				observable.subscribe(observer); // 上传开始	
				uploading = true;
			}
		</script>
	</body>
</html>
